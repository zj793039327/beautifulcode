<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>实时声音 Hz 展示</title>
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" />

    <style>
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    <script src="./mic-toggle-button.js"></script>

    <script type="module" src="./main.js">
        // import { createEssentiaNode } from "./essentia-worklet-node1.js";

        // let audioContext;
        // let gumStream;

        // let isRecording = false;

        // let micNode = null;
        // let essentiaNode = null;
        // let analyserNode = null;
        // let analyserData = null;

        // let animationID;

        // // show console.log on html div
        // window.console.logToScreen = function (str) {
        //     let node = document.createElement("div");
        //     node.appendChild(document.createTextNode(str));
        //     document.getElementById("myLog").appendChild(node);
        // };


        // const rmsValue = document.querySelector("#rms-value");

        // const audioButton = document.querySelector("#audio-button");

        // audioButton.addEventListener('click', function () {
        //     if (!isRecording) {
        //         audioContext = audioButton.audio.ctx;
        //         startEssentiaAnalyser(audioContext).then(() => console.logToScreen('essentia analyzer started'));
        //         return;
        //     } else {
        //         gumStream.getAudioTracks().forEach((track) => {
        //             track.stop();
        //             gumStream.removeTrack(track);
        //         });
        //         console.logToScreen('Closing audio context ...');

        //         micNode.disconnect();
        //         analyserNode.disconnect();
        //         essentiaNode.disconnect();
        //         // micNode = null;
        //         // essentiaNode = null;

        //         cancelAnimationFrame(animationID);

        //         isRecording = false;
        //     }
        // })

        // function draw() {
        //     animationID = requestAnimationFrame(draw);
        //     analyserNode.getFloatTimeDomainData(analyserData);
        //     let rms = analyserData[0];
        //     let dbFS = 20 * Math.log10((rms + Number.EPSILON) * Math.sqrt(2));
        //     // lowpass value for easier visualization
        //     let smoothedVal = smoother.lowpass(dbFS);
        //     rmsValue.innerText = smoothedVal;
        // }

        // async function setupAudioGraph(stream) {
        //     gumStream = stream;
        //     if (gumStream.active) {
        //         console.logToScreen('Sample Rate = ' + audioContext.sampleRate);
        //         micNode = audioContext.createMediaStreamSource(stream);
        //         analyserNode = audioContext.createAnalyser();
        //         analyserNode.fftSize = 2 * 128;
        //         analyserData = new Float32Array(analyserNode.frequencyBinCount);

        //         // create essentia node only once (avoid registering processor repeatedly)
        //         if (!essentiaNode) {
        //             console.logToScreen("Creating EssentiaNode instance ...")
        //             essentiaNode = await createEssentiaNode(audioContext);
        //         }

        //         console.logToScreen("Mic => essentiaWorklet => audioContext.destination ....");
        //         console.logToScreen("Calculating RMS level from microphone input ....");
        //         // connect mic stream to essentia node
        //         audioButton.connectToAudioNode(essentiaNode);
        //         // If it isn't connected to destination, the worklet is not executed
        //         essentiaNode.connect(analyserNode);

        //         draw(analyserData);

        //         isRecording = true;
        //     } else {
        //         throw 'Mic stream not active';
        //     }
        // }
        // async function startEssentiaAnalyser(audioContext) {
        //     if (navigator.mediaDevices.getUserMedia) {
        //         document.getElementById("myLog").innerHTML = ""; // empty on-screen log
        //         console.logToScreen(".................................")
        //         console.logToScreen('Initializing mic input stream ...')
        //         navigator.mediaDevices.getUserMedia(
        //             {
        //                 audio: {
        //                     sampleRate: {
        //                         exact: audioContext.sampleRate
        //                     }
        //                 },
        //                 video: false
        //             }).then((stream) => {
        //                 setupAudioGraph(stream);
        //             }).catch(function (message) {
        //                 throw 'Could not access microphone - ' + message;
        //             });
        //     } else {
        //         throw 'Could not access microphone - getUserMedia not available';
        //     }
        // }
    </script>

    <div class="ui container">
        <h2 class="ui header">实时展示音频HZ</h2>

        <mic-toggle-button id="audio-button" style="font-size: 1.75rem;"></mic-toggle-button>

        <div id="rms" class="ui segment"
            style="width: 30rem; font-size: 4rem; color: #000000; text-align: center; display: grid; grid-template-columns: 50% 50%;">
            <span id="rms-value">0</span> <span>dBFS</span>
            <!-- <input id="rms-value" type="text" style="min-width: 55%; text-align: right;" readonly>
        <span id="rms-units" class="ui basic label">dBFS</span> -->
        </div>

        <div id="req" class="ui segment"
        style="width: 30rem; font-size: 4rem; color: #000000; text-align: center; display: grid; grid-template-columns: 50% 50%;">
        <span id="req-value">0</span> <span>Hz</span>
        <!-- <input id="rms-value" type="text" style="min-width: 55%; text-align: right;" readonly>
    <span id="rms-units" class="ui basic label">dBFS</span> -->
    </div>

        <div id="myLog" class="ui message">
            这是一条通知消息
        </div>


    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>

</body>

</html>